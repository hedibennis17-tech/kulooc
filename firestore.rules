rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Constantes ────────────────────────────────────────────────────────────
    // Email du super administrateur KULOOC
    // Toutes les règles ci-dessous accordent un accès complet à cet utilisateur.

    // ── Fonctions utilitaires ─────────────────────────────────────────────────

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingDoc() {
      return resource != null;
    }

    function isOwnerOfExistingDoc(userId) {
      return isOwner(userId) && isExistingDoc();
    }

    function isImmutable(fieldName) {
      return request.resource.data[fieldName] == resource.data[fieldName];
    }

    // Vérifie si l'utilisateur connecté est le super admin (par email)
    function isSuperAdmin() {
      return isSignedIn() && request.auth.token.email == 'hedibennis17@gmail.com';
    }

    // Vérifie si l'utilisateur est admin (super admin OU admin enregistré dans admin_users)
    function isAdmin() {
      return isSuperAdmin() ||
        (isSignedIn() && exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)));
    }

    function isRideParticipant(rideDoc) {
      return isSignedIn() && (
        request.auth.uid == rideDoc.userId ||
        request.auth.uid == rideDoc.driverUserId
      );
    }

    // ── users ─────────────────────────────────────────────────────────────────
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      // Création : l'utilisateur connecté peut créer son propre profil (sans contrainte sur le champ id)
      allow create: if isOwner(userId);
      // Mise à jour : le propriétaire peut modifier son propre doc (existant ou nouveau via setDoc merge)
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwnerOfExistingDoc(userId) || isAdmin();
    }

    match /users/{userId}/addresses/{addressId} {
      allow get, list: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) && request.resource.data.ownerId == userId;
      allow update: if isOwnerOfExistingDoc(userId) && isImmutable('ownerId') || isAdmin();
      allow delete: if isOwnerOfExistingDoc(userId) || isAdmin();
    }

    // ── drivers ───────────────────────────────────────────────────────────────
    match /drivers/{driverId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update: if (isExistingDoc() && isOwner(resource.data.userId) && isImmutable('userId')) || isAdmin();
      allow delete: if (isExistingDoc() && isOwner(resource.data.userId)) || isAdmin();
    }

    // ── rides ─────────────────────────────────────────────────────────────────
    match /rides/{rideId} {
      allow get: if isRideParticipant(resource.data) || isAdmin();
      allow list: if isAdmin();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if (isExistingDoc() && isRideParticipant(resource.data)) || isAdmin();
      allow delete: if (isExistingDoc() && isRideParticipant(resource.data)) || isAdmin();
    }

    // ── ride_requests ─────────────────────────────────────────────────────────
    match /ride_requests/{requestId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn() && resource.data.passengerId == request.auth.uid || isAdmin();
    }

    // ── active_rides ──────────────────────────────────────────────────────────
    match /active_rides/{rideId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isAdmin();
    }

    // ── completed_rides ───────────────────────────────────────────────────────
    match /completed_rides/{rideId} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.passengerId == request.auth.uid ||
        resource.data.driverId == request.auth.uid
      ));
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    // ── zones ─────────────────────────────────────────────────────────────────
    match /zones/{zoneId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ── system_config ─────────────────────────────────────────────────────────
    match /system_config/{configId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ── services ──────────────────────────────────────────────────────────────
    match /services/{serviceId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // ── promotions ────────────────────────────────────────────────────────────
    match /promotions/{promotionId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // ── pointsOfInterest ──────────────────────────────────────────────────────
    match /pointsOfInterest/{poiId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // ── appConfigurations ─────────────────────────────────────────────────────
    match /appConfigurations/{configId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // ── highDemandZones ───────────────────────────────────────────────────────
    match /highDemandZones/{zoneId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // ── driver_offers ────────────────────────────────────────────────────────
    // Offers sent to drivers for ride requests
    match /driver_offers/{offerId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isAdmin();
    }

    // ── ratings ───────────────────────────────────────────────────────────────
    match /ratings/{ratingId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    // ── notifications ─────────────────────────────────────────────────────────
    match /notifications/{notifId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid || isAdmin();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid || isAdmin();
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid || isAdmin();
    }

    // ── favorite_addresses ────────────────────────────────────────────────────
    match /favorite_addresses/{addressId} {
      allow get, list: if (isSignedIn() && resource.data.userId == request.auth.uid) || isAdmin();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if (isSignedIn() && resource.data.userId == request.auth.uid && isImmutable('userId')) || isAdmin();
      allow delete: if (isSignedIn() && resource.data.userId == request.auth.uid) || isAdmin();
    }

    // ── driver_documents ──────────────────────────────────────────────────────
    match /driver_documents/{documentId} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.driverId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      ));
      allow create: if isSignedIn() && (
        request.resource.data.driverId == request.auth.uid ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAdmin() || (isSignedIn() && (
        resource.data.driverId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      ));
      allow delete: if isAdmin() || (isSignedIn() && (
        resource.data.driverId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      ));
    }

    // ── background_checks ─────────────────────────────────────────────────────
    match /background_checks/{checkId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow delete: if isAdmin();
    }

    // ── training_certificates ─────────────────────────────────────────────────
    match /training_certificates/{certId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow delete: if isAdmin();
    }

    // ── admin_users ───────────────────────────────────────────────────────────
    // Le super admin peut tout lire/écrire. Les autres admins peuvent lire leur propre doc.
    match /admin_users/{userId} {
      allow get: if isSuperAdmin() || isOwner(userId);
      allow list: if isSuperAdmin();
      allow create, update: if isSuperAdmin() || isOwner(userId);
      allow delete: if isSuperAdmin();
    }


    // ── bonuses ───────────────────────────────────────────────────────────────
    match /bonuses/{bonusId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.driverId == request.auth.uid);
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ── messages ──────────────────────────────────────────────────────────────
    match /messages/{messageId} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.recipientId == request.auth.uid
      ));
      allow create: if isSignedIn();
      allow update: if isAdmin() || (isSignedIn() && resource.data.recipientId == request.auth.uid);
      allow delete: if isAdmin();
    }

    // ── sms_logs ──────────────────────────────────────────────────────────────
    match /sms_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ── h3_cells_aggregates ───────────────────────────────────────────────────
    match /h3_cells_aggregates/{cellId} {
      allow read: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ── analytics / reports ───────────────────────────────────────────────────
    match /analytics/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /reports/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ── settings ──────────────────────────────────────────────────────────────
    match /settings/{settingId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ── Règle par défaut : tout refuser ───────────────────────────────────────
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
