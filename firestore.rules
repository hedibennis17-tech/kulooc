rules_version = '2';
/**
 * KULOOC — Règles de sécurité Firestore
 * Directive 7 : rôles stricts, protection ride_requests et rides
 *
 * Rôles :
 *   - super_admin  : hedibennis17@gmail.com — accès total
 *   - admin/dispatcher : dans admin_users — accès étendu
 *   - driver : dans drivers/{uid} — accès à ses propres données + courses assignées
 *   - client : dans users/{uid} — accès à ses propres demandes/courses
 */
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Fonctions utilitaires ─────────────────────────────────────────────────

    function isSignedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function isOwner(userId) {
      return isSignedIn() && uid() == userId;
    }

    function isExistingDoc() {
      return resource != null;
    }

    function isImmutable(fieldName) {
      return request.resource.data[fieldName] == resource.data[fieldName];
    }

    // Super admin par email
    function isSuperAdmin() {
      return isSignedIn() && request.auth.token.email == 'hedibennis17@gmail.com';
    }

    // Admin ou dispatcher enregistré dans admin_users
    function isAdmin() {
      return isSuperAdmin() ||
        (isSignedIn() && exists(/databases/$(database)/documents/admin_users/$(uid())));
    }

    // Chauffeur enregistré dans drivers/{uid}
    function isDriver() {
      return isSignedIn() && exists(/databases/$(database)/documents/drivers/$(uid()));
    }

    // Chauffeur propriétaire d'une course (driverId == uid)
    function isRideDriver(rideData) {
      return isSignedIn() && rideData.driverId == uid();
    }

    // Passager propriétaire d'une course (passengerId == uid)
    function isRidePassenger(rideData) {
      return isSignedIn() && rideData.passengerId == uid();
    }

    // Participant à une course (passager OU chauffeur)
    function isRideParticipant(rideData) {
      return isRidePassenger(rideData) || isRideDriver(rideData);
    }

    // ── users ─────────────────────────────────────────────────────────────────
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if (isOwner(userId) && isExistingDoc()) || isAdmin();
    }

    match /users/{userId}/addresses/{addressId} {
      allow get, list: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) && request.resource.data.ownerId == userId;
      allow update: if (isOwner(userId) && isExistingDoc() && isImmutable('ownerId')) || isAdmin();
      allow delete: if (isOwner(userId) && isExistingDoc()) || isAdmin();
    }

    // ── drivers ───────────────────────────────────────────────────────────────
    // Directive 7 : le chauffeur peut lire/modifier son propre doc
    // Le dispatcher peut tout lire (pour la carte temps réel)
    match /drivers/{driverId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn(); // Dispatcher + moteur dispatch
      allow create: if isSignedIn() && (
        request.resource.data.userId == uid() ||
        request.resource.data.uid == uid() ||
        driverId == uid()
      );
      allow update: if (
        isExistingDoc() && (
          // Le chauffeur met à jour son propre doc (status, location, sessionToken, lastSeen)
          (resource.data.userId == uid() || resource.data.uid == uid() || driverId == uid())
        )
      ) || isAdmin();
      allow delete: if (isExistingDoc() && (resource.data.userId == uid() || driverId == uid())) || isAdmin();
    }

    // ── ride_requests ─────────────────────────────────────────────────────────
    // Directive 7 : protection stricte
    //   - Création : client authentifié uniquement (passengerId == uid)
    //   - Lecture : passager propriétaire, chauffeur assigné, admin, ou chauffeur actif
    //   - Mise à jour : passager (annulation), chauffeur assigné (accepter/refuser), admin
    //   - Suppression : passager propriétaire ou admin
    //
    // Note: Pour le dispatch engine, les chauffeurs actifs peuvent lire les demandes
    // pending pour recevoir des offres. Le dispatch engine filtre ensuite côté serveur.
    match /ride_requests/{requestId} {
      allow create: if isSignedIn() && (
        request.resource.data.passengerId == uid() ||
        request.resource.data.userId == uid()
      );
      // Lecture : admin peut tout voir, sinon le participant ou chauffeur actif
      allow read: if isAdmin() || (
        isSignedIn() && (
          resource.data.passengerId == uid() ||
          resource.data.userId == uid() ||
          resource.data.offeredToDriverId == uid() ||
          resource.data.driverId == uid() ||
          // Chauffeurs actifs peuvent voir les demandes pending pour le dispatch
          isDriver()
        )
      );
      // Mise à jour : admin (dispatch), chauffeur assigné (accepter/refuser), passager (annuler)
      allow update: if isAdmin() || (
        isSignedIn() && (
          resource.data.passengerId == uid() ||
          resource.data.userId == uid() ||
          resource.data.offeredToDriverId == uid() ||
          resource.data.driverId == uid() ||
          // Chauffeurs peuvent mettre à jour pour accepter/refuser des offres
          isDriver()
        )
      );
      allow delete: if isAdmin() || (
        isSignedIn() && (
          resource.data.passengerId == uid() ||
          resource.data.userId == uid()
        )
      );
    }

    // ── active_rides ──────────────────────────────────────────────────────────
    // Directive 7 : seuls les participants et l'admin peuvent lire/modifier
    match /active_rides/{rideId} {
      allow read: if isAdmin() || (isSignedIn() && isRideParticipant(resource.data));
      allow create: if isAdmin() || isSignedIn(); // Moteur dispatch crée la course
      allow update: if isAdmin() || (isSignedIn() && isRideParticipant(resource.data));
      allow delete: if isAdmin();
    }

    // ── rides ─────────────────────────────────────────────────────────────────
    match /rides/{rideId} {
      allow get: if isAdmin() || (isSignedIn() && isRideParticipant(resource.data));
      allow list: if isAdmin();
      allow create: if isSignedIn() && (
        request.resource.data.passengerId == uid() ||
        request.resource.data.userId == uid()
      );
      allow update: if isAdmin() || (isSignedIn() && isRideParticipant(resource.data));
      allow delete: if isAdmin();
    }

    // ── completed_rides ───────────────────────────────────────────────────────
    match /completed_rides/{rideId} {
      allow read: if isAdmin() || (isSignedIn() && isRideParticipant(resource.data));
      allow create: if isAdmin() || isSignedIn(); // Moteur dispatch complète la course
      allow update, delete: if isAdmin();
    }

    // ── driver_offers ─────────────────────────────────────────────────────────
    // Directive 7 : le chauffeur ne peut lire que ses propres offres
    match /driver_offers/{offerId} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.driverId == uid()
      ));
      allow create: if isAdmin() || isSignedIn(); // Moteur dispatch crée les offres
      allow update: if isAdmin() || (isSignedIn() && (
        resource.data.driverId == uid() // Chauffeur accepte/refuse
      ));
      allow delete: if isAdmin();
    }

    // ── clients ───────────────────────────────────────────────────────────────
    match /clients/{clientId} {
      allow get: if isOwner(clientId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(clientId);
      allow update: if isOwner(clientId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ── zones ─────────────────────────────────────────────────────────────────
    match /zones/{zoneId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ── system_config ─────────────────────────────────────────────────────────
    match /system_config/{configId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ── services ──────────────────────────────────────────────────────────────
    match /services/{serviceId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // ── promotions ────────────────────────────────────────────────────────────
    match /promotions/{promotionId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // ── pointsOfInterest ──────────────────────────────────────────────────────
    match /pointsOfInterest/{poiId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // ── appConfigurations ─────────────────────────────────────────────────────
    match /appConfigurations/{configId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // ── highDemandZones ───────────────────────────────────────────────────────
    match /highDemandZones/{zoneId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // ── ratings ───────────────────────────────────────────────────────────────
    match /ratings/{ratingId} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.raterId == uid() ||
        resource.data.ratedId == uid()
      ));
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    // ── notifications ─────────────────────────────────────────────────────────
    match /notifications/{notifId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == uid());
      allow create: if isSignedIn();
      allow update: if isAdmin() || (isSignedIn() && resource.data.userId == uid());
      allow delete: if isAdmin() || (isSignedIn() && resource.data.userId == uid());
    }

    // ── favorite_addresses ────────────────────────────────────────────────────
    match /favorite_addresses/{addressId} {
      allow get, list: if isAdmin() || (isSignedIn() && resource.data.userId == uid());
      allow create: if isSignedIn() && request.resource.data.userId == uid();
      allow update: if isAdmin() || (isSignedIn() && resource.data.userId == uid() && isImmutable('userId'));
      allow delete: if isAdmin() || (isSignedIn() && resource.data.userId == uid());
    }

    // ── driver_documents ──────────────────────────────────────────────────────
    match /driver_documents/{documentId} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.driverId == uid() || resource.data.userId == uid()
      ));
      allow create: if isSignedIn() && (
        request.resource.data.driverId == uid() || request.resource.data.userId == uid()
      );
      allow update: if isAdmin() || (isSignedIn() && (
        resource.data.driverId == uid() || resource.data.userId == uid()
      ));
      allow delete: if isAdmin() || (isSignedIn() && (
        resource.data.driverId == uid() || resource.data.userId == uid()
      ));
    }

    // ── background_checks ─────────────────────────────────────────────────────
    match /background_checks/{checkId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == uid());
      allow create: if isSignedIn() && request.resource.data.userId == uid();
      allow update: if isAdmin() || (isSignedIn() && resource.data.userId == uid());
      allow delete: if isAdmin();
    }

    // ── training_certificates ─────────────────────────────────────────────────
    match /training_certificates/{certId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == uid());
      allow create: if isSignedIn() && request.resource.data.userId == uid();
      allow update: if isAdmin() || (isSignedIn() && resource.data.userId == uid());
      allow delete: if isAdmin();
    }

    // ── admin_users ───────────────────────────────────────────────────────────
    match /admin_users/{userId} {
      allow get: if isSuperAdmin() || isOwner(userId) || isAdmin();
      allow list: if isSuperAdmin() || isAdmin();
      allow create: if isSuperAdmin() ||
        (isAdmin() && request.resource.data.role != 'super_admin' && request.resource.data.role != 'super-admin');
      allow update: if isSuperAdmin() ||
        (isAdmin() &&
         resource.data.role != 'super_admin' && resource.data.role != 'super-admin' &&
         request.resource.data.role != 'super_admin' && request.resource.data.role != 'super-admin');
      allow delete: if isSuperAdmin();
    }

    // ── bonuses ───────────────────────────────────────────────────────────────
    match /bonuses/{bonusId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.driverId == uid());
      allow create, update, delete: if isAdmin();
    }

    // ── messages ──────────────────────────────────────────────────────────────
    match /messages/{messageId} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.senderId == uid() || resource.data.recipientId == uid()
      ));
      allow create: if isSignedIn();
      allow update: if isAdmin() || (isSignedIn() && resource.data.recipientId == uid());
      allow delete: if isAdmin();
    }

    // ── sms_logs ──────────────────────────────────────────────────────────────
    match /sms_logs/{logId} {
      allow read, write: if isAdmin();
    }

    // ── h3_cells_aggregates ───────────────────────────────────────────────────
    match /h3_cells_aggregates/{cellId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ── analytics / reports / settings ────────────────────────────────────────
    match /analytics/{docId} {
      allow read, write: if isAdmin();
    }
    match /reports/{docId} {
      allow read, write: if isAdmin();
    }
    match /settings/{settingId} {
      allow read, write: if isAdmin();
    }

    // ── Règle par défaut : admin seulement ────────────────────────────────────
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
