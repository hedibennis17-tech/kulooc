rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingDoc() {
      return resource != null;
    }

    function isOwnerOfExistingDoc(userId) {
      return isOwner(userId) && isExistingDoc();
    }
    
    function isRideParticipant(rideDoc) {
      return isSignedIn() && (request.auth.uid == rideDoc.userId || request.auth.uid == rideDoc.driverUserId);
    }

    function isImmutable(fieldName) {
      return request.resource.data[fieldName] == resource.data[fieldName];
    }

    // ── USERS ─────────────────────────────────────────────────────────────────
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwnerOfExistingDoc(userId) && isImmutable('id');
      allow delete: if isOwnerOfExistingDoc(userId);
    }

    match /users/{userId}/addresses/{addressId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.ownerId == userId;
      allow update: if isOwnerOfExistingDoc(userId) && isImmutable('ownerId');
      allow delete: if isOwnerOfExistingDoc(userId);
    }

    // ── DRIVERS ───────────────────────────────────────────────────────────────
    // NOUVEAU: Permettre aux chauffeurs de créer et modifier leur profil
    match /drivers/{driverId} {
      allow read: if true;  // Public read pour trouver les chauffeurs disponibles
      allow create: if isSignedIn();  // N'importe quel utilisateur authentifié peut devenir chauffeur
      allow update: if isSignedIn() && (
        // Le chauffeur peut modifier son propre profil
        (isExistingDoc() && resource.data.userId == request.auth.uid) ||
        // Ou si c'est un nouveau profil en cours de création
        request.resource.data.userId == request.auth.uid
      );
      allow delete: if isExistingDoc() && resource.data.userId == request.auth.uid;
    }

    // ── DRIVER DOCUMENTS ──────────────────────────────────────────────────────
    // NOUVEAU: Collection pour les documents des chauffeurs
    match /driver_documents/{documentId} {
      allow read: if isSignedIn() && resource.data.driverId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.driverId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.driverId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.driverId == request.auth.uid;
    }

    // ── RIDES ─────────────────────────────────────────────────────────────────
    match /rides/{rideId} {
      allow get: if isRideParticipant(resource.data);
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingDoc() && isRideParticipant(resource.data);
      allow delete: if isExistingDoc() && isRideParticipant(resource.data);
    }

    // ── RIDE REQUESTS ─────────────────────────────────────────────────────────
    match /ride_requests/{requestId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn() && resource.data.passengerId == request.auth.uid;
    }

    // ── ACTIVE RIDES ──────────────────────────────────────────────────────────
    match /active_rides/{rideId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if false;
    }

    // ── COMPLETED RIDES ───────────────────────────────────────────────────────
    match /completed_rides/{rideId} {
      allow read: if isSignedIn() && (
        resource.data.passengerId == request.auth.uid ||
        resource.data.driverId == request.auth.uid
      );
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    // ── PUBLIC READ-ONLY CONFIGURATIONS ───────────────────────────────────────
    match /services/{serviceId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    match /promotions/{promotionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    match /pointsOfInterest/{poiId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    match /appConfigurations/{configId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    match /highDemandZones/{zoneId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    // ── DEFAULT DENY ALL ──────────────────────────────────────────────────────
    // Toutes les autres collections sont bloquées par défaut
  }
}
